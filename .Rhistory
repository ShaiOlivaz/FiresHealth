by = join_by(name_muni, name_state),
relationship = "many-to-one"
)
string |>
stringr::str_to_lower() |>
stringi::stri_trans_general("Latin-ASCII")
str_strip <- function(string) {
string |>
stringr::str_to_lower() |>
stringi::stri_trans_general("Latin-ASCII")
}
fires_ref_sat_names <- fires_ref_sat_sample |>
mutate(
name_muni = str_strip(municipio),
name_state = str_strip(estado)
) |>
select(-municipio, -estado) |>
left_join(
muni_dict,
by = join_by(name_muni, name_state),
relationship = "many-to-one"
)
View(fires_ref_sat_names)
fires_ref_sat_names <- fires_ref_sat |>
mutate(
name_muni = str_strip(municipio),
name_state = str_strip(estado)
) |>
select(-municipio, -estado) |>
left_join(
muni_dict,
by = join_by(name_muni, name_state),
relationship = "many-to-one"
)
fires_ref_sat_names |>
slice_head(n = 15) |>
collect()
str_strip <- function(context, string) {
string |>
stringr::str_to_lower() |>
stringi::stri_trans_general("Latin-ASCII")
}
register_scalar_function(
name = "str_strip",
fun = str_strip,
in_type = string(),
out_type = string(),
auto_convert = TRUE
)
fires_ref_sat_names <- fires_ref_sat |>
mutate(
name_muni = str_strip(municipio),
name_state = str_strip(estado)
) |>
select(-municipio, -estado) |>
left_join(
muni_dict,
by = join_by(name_muni, name_state),
relationship = "many-to-one"
)
fires_ref_sat_names |>
slice_head(n = 15) |>
collect()
# Check if any municipality remains unmatched
fires_ref_sat_names |>
anti_join(
muni_dict,
by = join_by(name_muni, name_state),
)
# Check if any municipality remains unmatched
fires_ref_sat_names |>
anti_join(
muni_dict,
by = join_by(name_muni, name_state),
) |>
summarise(
n()
)
# Check if any municipality remains unmatched
fires_ref_sat_names |>
anti_join(
muni_dict,
by = join_by(name_muni, name_state),
) |>
summarise(n()) |>
collect()
# Check if any municipality remains unmatched
fires_ref_sat_names |>
summarise(n()) |>
collect()
# Check if any municipality remains unmatched
fires_ref_sat_names |>
anti_join(
muni_dict,
by = join_by(name_muni, name_state),
) |>
select(
code_muni, name_muni, name_state
) |>
unique()
# Check if any municipality remains unmatched
fires_ref_sat_names |>
anti_join(
muni_dict,
by = join_by(name_muni, name_state),
) |>
select(
code_muni, name_muni, name_state
) |>
unique() |>
collect()
View(muni_dict)
View(fires_ref_sat_sample)
install.packages("fuzzyjoin")
## create connection
conn <- dbConnect(duckdb())
## install and load spatial extension
ddbs_install(conn)
library(duckspatial )
## create connection
conn <- dbConnect(duckdb())
## install and load spatial extension
ddbs_install(conn)
ddbs_load(conn)
ddbs_write_vector(conn, muni_seat, "test_points")
ddbs_write_vector(conn, muni_seat, "muni_seat")
rm(fires_ref_sat_AAAA, fires_ref_sat_names)
to_duckdb(fires_ref_sat, con = conn, table_name = "fires_ref_sat")
View(muni_seat)
View(muni_seat)
muni_seat <- read_municipal_seat(year = 2010) |>
# Bring State names
left_join(
read_state() |>
as_tibble() |>
mutate(code_state = as.character(code_state)) |>
select(code_state, name_state),
by = "code_state"
) |>
# Minimalist dataframe
select(
code_muni,
name_muni,
name_state,
geom
)
View(muni_seat)
bulk_write_rds(
muni_seat
)
bulk_write_rds(
muni_seat
)
ddbs_write_vector(conn, muni_seat, "muni_seat")
ddbs_write_vector(conn, muni_seat, "muni_seat", overwrite = T)
fires_ref_sat |>
to_duckdb(con = conn, table_name = "fires_ref_sat")
ddbs_write_vector(conn, muni_seat, "muni_seat", overwrite = T)
to_duckdb(fires_ref_sat, con = conn, table_name = "fires_ref_sat")
ddbs_write_vector(conn, muni_seat, "muni_seat", overwrite = T)
to_duckdb(fires_ref_sat, con = conn, table_name = "fires_ref_sat")
to_duckdb(fires_ref_sat_sample, con = conn, table_name = "fires_test")
muni_seat <- read_municipal_seat(year = 2010) |>
# Bring State names
left_join(
read_state() |>
as_tibble() |>
mutate(code_state = as.character(code_state)) |>
select(code_state, name_state),
by = "code_state"
) |>
# Minimalist dataframe
select(
code_muni,
name_muni,
name_state,
geom
) |>
# Include latitude and longitude
muni_seat |>
mutate(
lat_muni = st_coordinates()
)
# Data Wrangling
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
# Geographic
library(sf)
library(geobr)
# Personal functions
source("./Functions/bulk_rds.R")
muni_seat <- read_municipal_seat(year = 2010) |>
# Bring State names
left_join(
read_state() |>
as_tibble() |>
mutate(code_state = as.character(code_state)) |>
select(code_state, name_state),
by = "code_state"
) |>
# Minimalist dataframe
select(
code_muni,
name_muni,
name_state,
geom
) |>
# Include latitude and longitude
muni_seat |>
mutate(
lat_muni = st_coordinates()
)
muni_seat |>
mutate(
lat_muni = st_coordinates()
)
muni_seat |>
mutate(
lat_muni = st_coordinates(geom)
)
muni_seat |>
mutate(
lat_muni, lon_muni = st_coordinates(geom)
)
muni_seat |>
mutate(
lat_muni, lon_muni = st_coordinates(geom)
)
st_coordinates(muni_seat$geom[1])
st_coordinates(muni_seat$geom[,1])
st_coordinates(muni_seat$geom)
muni_seat |>
mutate(
lat_muni = st_coordinates(geom)[0,1]
)
muni_seat |>
mutate(
lat_muni = st_coordinates(geom)[,1]
)
muni_seat |>
mutate(
lon_muni = st_coordinates(geom)[,1],
lat_muni = st_coordinates(geom)[,2]
)
muni_seat <- read_municipal_seat(year = 2010) |>
# Bring State names
left_join(
read_state() |>
as_tibble() |>
mutate(code_state = as.character(code_state)) |>
select(code_state, name_state),
by = "code_state"
) |>
# Minimalist dataframe
select(
code_muni,
name_muni,
name_state,
geom
) |>
# Get latitude and longitude
mutate(
lon_muni = st_coordinates(geom)[,1],
lat_muni = st_coordinates(geom)[,2]
)
bulk_write_rds(
muni_seat
)
View(fires_ref_sat_sample)
# sample test
fires_ref_sat_sample |>
to_duckdb(fires_ref_sat_sample, con = conn, table_name = "fires_test") |>
buffer = 50*1000 # in meters
# sample test
fires_ref_sat_sample |>
to_duckdb(con = conn, table_name = "fires_test", overwrite = T)
# sample test
fires_ref_sat_sample |>
to_duckdb(con = conn, table_name = "fires_test")
# sample test
fires_ref_sat_sample |>
to_duckdb(con = conn, table_name = "fires_test") |>
mutate(
geom = st_point(list(lon, lat)))
# sample test
fires_ref_sat_sample |>
to_duckdb() |>
mutate(
geom = st_point(list(lon, lat)))
# sample test
fires_ref_sat_sample |>
mutate(
geom = st_point(list(lon, lat)))
# sample test
fires_ref_sat_sample |>
mutate(
geom = st_point(list(lon, lat)))
# sample test
fires_ref_sat_sample |>
mutate(
geom = st_point(c(lon, lat)))
st_crs(muni_seat)
# sample test
fires_ref_sat_sample |>
st_as_sf(
coords = c("lon", "lat"), # Order matters: Longitude (X), then Latitude (Y)
crs = st_crs(muni_seat),               # 4326 is the code for WGS84 (Standard GPS)
)
# sample test
fires_ref_sat_sample |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
)
# sample test
st_as_sf(
fires_ref_sat_sample,
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
View(fires_ref_sat_sample)
# sample test
fires_ref_sat_sample |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
View(fires_ref_sat_sample)
View(sisam_sample)
View(sisam_sample)
# sample test
fires_ref_sat_sample |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
# sample test
fires_test <- fires_ref_sat_sample |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
to_duckdb(fires_test, con = conn, table_name = "fires_test")
# sample test
fires_test <- fires_ref_sat_sample |>
to_duckdb() |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
library(geoarrow)
# sample test
fires_test <- fires_ref_sat_sample |>
as_geoarrow_table() |>
to_duckdb() |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
# sample test
fires_test <- fires_ref_sat_sample |>
as_geoarrow_vctr() |>
to_duckdb() |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
# sample test
fires_test <- fires_ref_sat_sample |>
as_geoarrow_vctr() |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
# sample test
fires_ref_sat_sample |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
) |>
as_geoarrow_vctr() |>
to_duckdb(fires_test, con = conn, table_name = "fires_test")
# sample test
fires_ref_sat_sample |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
) |>
as_geoarrow_vctr()
# sample test
fires_ref_sat_sample |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
) |>
as_geoarrow_vctr() |>
to_duckdb()
# sample test
fires_test <- fires_ref_sat_sample |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
) |>
as_geoarrow_vctr()
to_duckdb(fires_test, con = conn, table_name = "fires_test")
ddbs_write_vector(fires_test, con = conn, table_name = "fires_test")
ddbs_write_vector(fires_test, con = conn, table_name = "fires_test")
ddbs_join(
"fires_test",
"muni_seat",
join = ST_DWithin(buffer),
conn = conn,
name = "fires_by_muni"
)
# Data Wrangling
library(dplyr)
library(tidyr)
library(stringr)
library(stringi)
library(readr)
library(lubridate)
library(fuzzyjoin)
# Fast Data
library(arrow)
library(duckdb)
library(dbplyr)
library(duckspatial)
# Geographic
library(sf)
library(duckspatial)
library(geoarrow)
# Personal functions
source("./Functions/bulk_rds.R")
ddbs_write_vector(fires_test, con = conn, table_name = "fires_test")
to_duckdb(fires_ref_sat, con = conn, table_name = "fires_ref_sat")
# sample test
fires_test <- fires_ref_sat_sample |>
select(
- c(foco_id, pais, estado, municipio)
) |>
st_as_sf(
coords = c("lon", "lat"),
crs = st_crs(muni_seat),
remove = FALSE
)
ddbs_write_vector(fires_test, con = conn, table_name = "fires_test")
## create connection
conn <- dbConnect(duckdb())
## install and load spatial extension
ddbs_install(conn)
ddbs_load(conn)
ddbs_write_vector(conn, muni_seat, "muni_seat", overwrite = T)
ddbs_write_vector(fires_test, con = conn, table_name = "fires_test", overwrite = T)
ddbs_write_vector(conn, fires_test, "fires_test", overwrite = T)
buffer = 50*1000 # in meters
ddbs_join(
"fires_test",
"muni_seat",
join = ST_DWithin(buffer),
conn = conn,
name = "fires_by_muni"
)
install.packages("pak")
pak::pak("Cidree/duckspatial")
pkgbuild::check_build_tools(debug = TRUE)
install.packages("pkgbuild")
pkgbuild::check_build_tools(debug = TRUE)
pkgbuild::check_build_tools(debug = TRUE)
